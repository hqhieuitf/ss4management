function reloadLSX(){arrLSXuat=[],clsApi.request("/LSXuat/getAllByDateRange",function(a){arrLSXuat=a.data},null,{type:"POST",dataType:"json",data:{tungay:$("#cbxFromDate").val(),denngay:$("#cbxToDate").val()},error_message:"Có lỗi kết nối, vui lòng kiểm tra",waiting_message:"Vui lòng đợi...",bshowwaiting:!0})}function viewMain_checkloimay(a){return parseInt(a.loimay).formatMoney(0)}function viewMain_checkbag(a){return parseInt(a.checkbag).formatMoney(0)}function viewMain_goodbag(a){return parseInt(a.goodbag).formatMoney(0)}function viewMain_badbag(a){return parseInt(a.badbag).formatMoney(0)}function viewMasterOrDetailDesc(a){return 1==a.group?"<strong>"+a.desc+"</strong>":a.desc}function viewMasterOrDetailCondition(a){return 1==a.group?"":a.condition}function viewMasterOrDetailQty(a){return 1==a.group?"N05"==a.code?'<span id="txtN05" style="float:right;"></span>':"N05-1"==a.code?'<span id="txtN05-1" style="float:right;"></span>':"N06"==a.code?'<span id="txtN06" style="float:right;"></span>':"":a.qty}function calcSobaodat(){for(var a=$("#grid1").data().kendoGrid.dataSource.view(),b=0,c=!1,d=!1,e=!1,f=0,g=0,h=0,i=[],j=[],k=0;k<a.length;k++)1!=a[k].group&&0!=a[k].qty&&(b+=a[k].qty),c&&(i.push(a[k].qty),f+=a[k].qty),e&&(h+=a[k].qty),d&&(j.push(a[k].qty),g+=a[k].qty),"N05"==a[k].code&&(c=!0),"N05-1"==a[k].code&&(e=!0,c=!1),"N06"==a[k].code&&(c=!1,e=!1,d=!0);var l=$("#txtsobaokiem").data("kendoNumericTextBox").value();$("#txtsobaodat").data("kendoNumericTextBox").value(l-b),$("#toolSCheck").html(l.formatMoney(0)),$("#toolSGood").html((l-b).formatMoney(0)),$("#toolSBad").html(0==b?0:b.formatMoney(0)),$("#txtN05").html(f),$("#txtLoimay").html(f),$("#txtN05-1").html(h),$("#txtLoimay-1").html(h),$("#txtN06").html(g),$("#txtDForm").html(g)}function qtyEditor(a,b){1==b.model.group?$("#grid1").data("kendoGrid").closeCell():$('<input required name="'+b.field+'" />').appendTo(a).kendoNumericTextBox({step:1,spinners:!1,format:"n0",change:calcSobaodat})}function descEditor(a,b){1==b.model.group?$("#grid1").data("kendoGrid").closeCell():$('<input class="k-textbox" name="'+b.field+'"/>').appendTo(a)}function qtyEPEEditor(a,b){$('<input required name="'+b.field+'" />').appendTo(a).kendoNumericTextBox({step:1,spinners:!1,format:"n0"})}var viewAddModel=kendo.observable({isVisible:!0,oWin:null,masterid:null,dataMaster:null,dataDetail:null,frmSaving:!1,onInit:function(a,b){var c=this;this.masterid=b,this.dataMaster=null,this.dataDetail=[],this.oWin=a,clsApi.request("/errdatamrg/SelectDataForm",function(a){c.onInitToolbar(),c.onInitTab(a.detail,a.detailepe),c.onInitForm(a.master),c.oWin.center().open(),calcSobaodat()},null,{type:"POST",dataType:"json",data:{masterid:null==this.masterid?0:this.masterid},error_message:"Có lỗi kết nối, vui lòng kiểm tra",waiting_message:"Vui lòng đợi...",bshowwaiting:!0})},onChange:function(){},onInitForm:function(a){$("#cbCont").kendoComboBox({dataTextField:"name",dataValueField:"id",dataSource:arrCont,filter:"contains",suggest:!0}),$("#cbLSXuat").kendoComboBox({dataTextField:"name",dataValueField:"id",dataSource:arrLSXuat,filter:"contains",suggest:!0}),$("#cbProduct").kendoComboBox({dataTextField:"name",dataValueField:"id",dataSource:arrProduct,filter:"contains",suggest:!0});var b=$("#cbLine").kendoComboBox({dataTextField:"name",dataValueField:"id",dataSource:arrLine,filter:"contains",suggest:!0,enable:1==benable});if($("#cbEmployee").kendoComboBox({dataTextField:"name",dataValueField:"id",dataSource:arrEmployee,filter:"contains",suggest:!0,enable:1==benable}),$("#txtngaykiem").kendoDatePicker({parseFormats:["dd/MM/yyyy"],format:"dd/MM/yyyy",value:new Date,min:new Date(1950,0,1),max:new Date(2049,11,31)}),$("#txtsobaokiem").kendoNumericTextBox({step:1,spinners:!1,format:"n0",change:calcSobaodat}),$("#txtsobaodat").kendoNumericTextBox({step:1,spinners:!1,format:"n0"}),$("#txtphelieu").kendoNumericTextBox({step:1,spinners:!1,format:"n1"}),$("#txtlankiem").kendoNumericTextBox({step:1,spinners:!1,format:"n0"}),0!=a.length){$("#txtcode").val(a[0].code),$("#txtngaykiem").val(a[0].scheckdate),$("#txtsobaokiem").data("kendoNumericTextBox").value(a[0].checkbag),$("#txtsobaodat").data("kendoNumericTextBox").value(a[0].goodbag),$("#txtphelieu").data("kendoNumericTextBox").value(a[0].scrap),$("#txtlankiem").data("kendoNumericTextBox").value(a[0].timeno),$("#txtroll").val(a[0].roll);var b=$("#cbProduct").data("kendoComboBox");b.value(a[0].productid),b.trigger("change");var b=$("#cbCont").data("kendoComboBox");b.value(a[0].contid),b.trigger("change");var b=$("#cbLSXuat").data("kendoComboBox");b.value(a[0].lsxid),b.trigger("change");var b=$("#cbLine").data("kendoComboBox");b.value(a[0].lineid),b.trigger("change");var b=$("#cbEmployee").data("kendoComboBox");b.value(a[0].employeeid),b.trigger("change")}else clsApi.request("/GenCode/Index",function(a){$("#txtcode").val(a.code);var b=$("#cbLine").data("kendoComboBox");b.value(currLineId),b.trigger("change");var b=$("#cbEmployee").data("kendoComboBox");b.value(currEmployeeId),b.trigger("change")},null,{type:"POST",dataType:"json",data:{sLoai:"02"},error_message:"Có lỗi kết nối, vui lòng kiểm tra",waiting_message:"Vui lòng đợi...",bshowwaiting:!0})},onInitTab:function(a,b){var c=$("#tabstrip").kendoTabStrip({animation:{close:{duration:1,effects:"fadeOut"},open:{duration:1,effects:"fadeIn"}}}).data("kendoTabStrip");c.append([{text:"<b>CHI TIẾT KIỂM TRA</b>",encoded:!1,content:"<div id='grid1' style='height: 300px;'></div>"},{text:"<b>LỖI MAY NHÂN VIÊN</b>",encoded:!1,content:"<div id='grid_loimay' style='height: 300px;'></div>"}]),c.activateTab($(".k-tabstrip-items>.k-item")[0]);$("#grid1").kendoGrid({selectable:!0,allowCopy:!1,sortable:!0,reorderable:!0,groupable:!1,resizable:!0,editable:!0,filterable:ss4.kefilterable(),dataBound:function(a){for(var c=(a.sender.columns,this.wrapper.find(".k-grid-header [data-field=qty]").index()),d=this.wrapper.find(".k-grid-header [data-field=note]").index(),e=a.sender.tbody.children(),f=0;f<e.length;f++){var g=$(e[f]),h=a.sender.dataItem(g),i=h.get("group");if(1==i){g.addClass("grouperr");var j=$(g).attr("data-uid");$('div.k-grid-content-locked table.k-selectable tr[data-uid="'+j+'"]').addClass("grouperr")}if(1!=i){var k=g.children().eq(c);k.addClass("allowinputvalue"),k=g.children().eq(d),k.addClass("allowinputvalue")}}},columns:[{field:"code",title:"Code",width:"80px",editable:!1},{field:"desc",title:"Mô tả lỗi",width:"200px",editable:!1,template:viewMasterOrDetailDesc},{field:"condition",title:"Điều kiện",width:"200px",editable:!1,template:viewMasterOrDetailCondition},{field:"qty",title:"Số lượng",width:"100px",template:viewMasterOrDetailQty,editor:qtyEditor},{field:"note",title:"Ghi chú",width:"100px",editor:descEditor}],dataSource:a,edit:function(a){var b=a.container.context.cellIndex,c=$("#grid1").data("kendoGrid");"undefined"==b||"code"!=c.columns[b].field&&"desc"!=c.columns[b].field&&"condition"!=c.columns[b].field||$("#grid1").data("kendoGrid").closeCell()}}),$("#grid_loimay").kendoGrid({selectable:!0,allowCopy:!1,sortable:!0,reorderable:!0,groupable:!1,resizable:!0,editable:!0,filterable:ss4.kefilterable(),dataBound:function(a){},columns:[{field:"fullname",title:"Họ tên",width:"100px",editable:!1},{field:"qty",title:"Số lượng",width:"100px",template:function(a){return'<strong style="text-align:right;">'+a.qty+"</strong>"},editor:qtyEPEEditor},{field:"note",title:"Ghi chú",width:"200px",editor:function(a,b){$('<input class="k-textbox" name="'+b.field+'"/>').appendTo(a)}}],dataSource:b,edit:function(a){var b=a.container.context.cellIndex,c=$("#grid_loimay").data("kendoGrid");"undefined"!=b&&"fullname"==c.columns[b].field&&$("#grid_loimay").data("kendoGrid").closeCell()}})},onInitToolbar:function(){var a=this;$("#toolbarDlg").kendoToolBar({items:[{type:"button",id:"button1",text:"<div>&nbsp;</div>Lưu và đóng<div>&nbsp;</div>",click:function(b){a.btnSave_Click()}},{type:"button",id:"button2",text:"<div>&nbsp;</div>Bỏ qua<div>&nbsp;</div>",click:function(b){a.btnCancel_Click()}},{type:"button",id:"button5",text:"<div id='txtLoimay' style='font-weight:bold;color:red;'></div><div id='txtLoimay-1' style='font-weight:bold;color:red;'></div><div id='txtDForm' style='font-weight:bold;color:red;'></div>",attributes:{class:"text-right float-right"},click:function(){}},{type:"button",id:"button5",text:"<div style='font-weight:bold;color:red;'>Lỗi may:</div><div style='font-weight:bold;color:red;'>Lỗi quai xách:</div><div style='font-weight:bold;color:red;'>DForm:</div>",attributes:{class:"text-right float-right"},click:function(){}},{type:"button",id:"button3",text:"<div style='font-weight:bold;color:red;' id='toolSCheck'>0</div><div id='toolSBad' style='font-weight:bold;color:#333'>0</div><div id='toolSGood' style='font-weight:bold;color:#13ce13'>0</div>",attributes:{class:"text-right float-right"},click:function(){}},{type:"button",id:"button4",text:"<div style='font-weight:bold;color:red;'>Kiểm tra:</div><div style='font-weight:bold;color:#333'>Không đạt:</div><div style='font-weight:bold;color:#13ce13'>Đạt:</div>",attributes:{class:"text-right float-right"},click:function(){}}],click:function(a){},toggle:function(a){},overflowOpen:function(a){},overflowClose:function(a){},open:function(a){},close:function(a){}})},checkValidation:function(){var a=$("#frmData").kendoValidator().data("kendoValidator");return a.validate()},btnSave_Click:function(){var a=this;if(this.checkValidation()&&!a.frmSaving){for(var b={id:this.masterid,code:$("#txtcode").val(),productid:$("#cbProduct").val(),contid:$("#cbCont").val(),lsxid:$("#cbLSXuat").val(),lineid:$("#cbLine").val(),employeeid:$("#cbEmployee").val(),scheckdate:$("#txtngaykiem").val(),checkbag:$("#txtsobaokiem").val(),goodbag:$("#txtsobaodat").val(),scrap:$("#txtphelieu").val(),timeno:$("#txtlankiem").val(),roll:$("#txtroll").val()},c=[],d=[],e=$("#grid1").data().kendoGrid.dataSource.view(),f=$("#grid_loimay").data().kendoGrid.dataSource.view(),g=0;g<e.length;g++)1!=e[g].group&&0!=e[g].qty&&c.push({errcodeid:e[g].errid,qty:e[g].qty,note:e[g].note,masterid:this.masterid});for(var g=0;g<f.length;g++)0!=f[g].qty&&d.push({employeeid:f[g].employeeid,qty:f[g].qty,note:f[g].note,masterid:this.masterid});ss4.loading(!0,"Đang lưu dữ liệu..."),a.frmSaving=!0,$.ajax({url:"/errdatamrg/CreateOrUpdate",data:JSON.stringify({master:b,detail:c,detailEPE:d}),dataType:"json",type:"Post",contentType:"application/json; charset=utf-8",success:function(b){ss4.loading(!1,"Đang lưu dữ liệu..."),a.frmSaving=!1,b.err?ss4.shwNotification(b.msg,"error"):(ss4.shwNotification("Đã cập nhật dữ liệu.","info"),a.oWin.destroy(),viewMainModel.onRefresh())},error:function(){}})}},btnCancel_Click:function(){this.oWin.destroy()}}),viewMainModel=kendo.observable({isVisible:!0,sTungay:null,sDenngay:null,selectedRow:null,ModelEntity:function(){return kendo.observable({data:{}})},onDebug:function(a){},dataSource:null,onInit:function(){var a=this;if(null==a.sTungay){var b=(new Date).getMonth(),c=0;if(1==b||2==b||3==b)b=11,c=(new Date).getFullYear()-1,a.sTungay=ss4.dateToString(new Date(c,11,1)),a.sDenngay=ss4.dateToString(new Date((new Date).getFullYear(),(new Date).getMonth()+1,0));else{var d=new Date((new Date).getFullYear(),(new Date).getMonth()+1,0);a.sTungay=ss4.dateToString(new Date((new Date).getFullYear(),(new Date).getMonth()-3,1)),a.sDenngay=ss4.dateToString(d)}}a.onRefresh()},onRefresh:function(){var a=this;try{0!=$("#cbxFromDate").length&&(a.sTungay=$("#cbxFromDate").val(),a.sDenngay=$("#cbxToDate").val())}catch(a){}clsApi.request("/errdatamrg/SelectAllByDateRange",function(b){a.dataSource=b,kendo.bind($("#wrapperMain"),a),a.onResize();var c=$(".k-grid-content-locked").css("width");$(".k-grid-content-locked").attr("style","width:"+c),$(".toolbar").html(kendo.template($("#template").html()));$("#cbxFromDate").kendoDatePicker({parseFormats:["dd/MM/yyyy"],format:"dd/MM/yyyy"}).data("kendoDatePicker"),$("#cbxToDate").kendoDatePicker({parseFormats:["dd/MM/yyyy"],format:"dd/MM/yyyy"}).data("kendoDatePicker");$("#cbxFromDate").val(a.sTungay),$("#cbxToDate").val(a.sDenngay),$("#btnXem").click(function(){a.onRefresh()}),reloadLSX()},null,{type:"POST",dataType:"json",data:{tungay:a.sTungay,denngay:a.sDenngay},error_message:"Có lỗi kết nối, vui lòng kiểm tra",waiting_message:"Vui lòng đợi...",bshowwaiting:!0})},onResize:function(){var a=$(".wrapperGrid"),b=a.find(".k-grid-content"),d=(a.innerHeight(),a.children().not(".k-grid-content")),e=0;d.each(function(){e+=$(this).outerHeight()}),b.height(ss4.Screen().height-(parseInt($(".navContainer").css("height"))+parseInt($(".header").css("height"))+parseInt($(".subhead-collapse").css("height"))+152+43)),setTimeout(function(){$("div[data-role='grid']").data("kendoGrid").refresh()},500)},onChangeRow:function(a){this.set("selectedRow",a.sender.dataItem(a.sender.select()))},onClick_Edit:function(){if(null!=this.selectedRow){var a=$("<div id='popupWindow'></div>").appendTo("body").kendoWindow({width:ss4.Screen().width/1.2,modal:!0,title:"SỬA PHIẾU KIỂM TRA CHẤT LƯỢNG",visible:!1,animation:{open:{effects:"expand:vertical"},close:{effects:"expand:vertical",reverse:!0}},close:function(a){this.destroy()}}).data("kendoWindow").content($("#dlgTemplate").html());viewAddModel.onInit(a,this.selectedRow.id),kendo.bind($("#dlgAdd"),viewAddModel)}else ss4.shwNotification("Vui lòng chọn 1 dòng và thực hiện lại","error")},onClick_Add:function(){var a=$("<div id='popupWindow'></div>").appendTo("body").kendoWindow({width:ss4.Screen().width/1.2,modal:!0,title:"THÊM MỚI PHIẾU KIỂM TRA CHẤT LƯỢNG",visible:!1,animation:{open:{effects:"expand:vertical"},close:{effects:"expand:vertical",reverse:!0}},close:function(a){this.destroy()}}).data("kendoWindow").content($("#dlgTemplate").html());viewAddModel.onInit(a,0),kendo.bind($("#dlgAdd"),viewAddModel)},onClick_Remove:function(){var a=this;null!=this.selectedRow?ss4.confirm({title:"Confirm",message:'Bạn có chắc muốn xóa phiếu "'+this.selectedRow.code+'"?',width:300,height:150,icon:"info",fnCallback:function(){clsApi.request("/errdatamrg/delete",function(b){b.err?ss4.shwNotification(b.msg,"error"):(a.onRefresh(),ss4.shwNotification("Đã xóa thành công!","info"))},null,{type:"POST",dataType:"json",data:{masterid:a.selectedRow.id},error_message:"Có lỗi kết nối, vui lòng kiểm tra",waiting_message:"Vui lòng đợi...",bshowwaiting:!0})}}):ss4.shwNotification("Vui lòng chọn dòng và thực hiện lại","info")},onClick_View:function(){if(null!=this.selectedRow){var a=$("<div id='popupWindow'></div>").appendTo("body").kendoWindow({width:ss4.Screen().width/1.2,modal:!0,title:"PHIẾU KIỂM TRA CHẤT LƯỢNG",visible:!1,animation:{open:{effects:"expand:vertical"},close:{effects:"expand:vertical",reverse:!0}},close:function(a){this.destroy()}}).data("kendoWindow").content($("#dlgTemplate").html());viewAddModel.onInit(a,this.selectedRow.id),kendo.bind($("#dlgAdd"),viewAddModel),$("#toolbarDlg").hide()}else ss4.shwNotification("Vui lòng chọn 1 dòng và thực hiện lại","error")},onClick_Excel:function(){var a=$("div[data-role='grid']").data("kendoGrid");a.saveAsExcel()}});$(document).ready(function(){$("#breadcrumb").html('Nghiệp vụ <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span> Bảng kiểm lỗi'),viewMainModel.onInit(),kendo.bind($("#wrapperMain"),viewMainModel),$("#wrapperMain").on("dblclick"," tbody > tr",function(){alert("double click")})});